<!-- This page was created with the RAD auto-doc generator. -->
<!doctype html public "-//w3c//dtd html 3.2 final//en">
<html>
<head>
<title>DDK Function: 503H Install Timbre Set</title>
<meta http-equiv="content-type" content="text/html; charset=iso8859-1">
<meta name="ms.locale" content="en-us">
<meta name="description" content="">
<meta name="ms-hkwd" content="DDK Function: 503H Install Timbre Set">
<link rel="stylesheet" title="default" href="reference.css" type="text/css" media="screen">
</head>
<body topmargin="0">
<table cellspacing=0 cellpadding=0 class=bar width=100% height=25>
<tr class=bar>
<td class=bar>
<i>&nbsp;<a href="index.html" class=trn>Miles Sound System SDK 6.1c</a></i>
</td>
</tr>
</table>
<h1>DDK Function: 503H Install Timbre Set</h1>
<h4>Discussion</h4>
<p> <b>Input:</b><br> </p><p> AX = 503H<br> BX = Driver number<br> XMIDI TIMB chunk image copied to DST <b>MIDI_data</b>[] area </p><p><b>Output:</b><br> </p><p> AX = 1: All timbres successfully installed (or already present)<br> AX = 0: Error (BX = bank/patch specifier for failed operation) </p><p>The term "timbre" (pronounced TIM-ber or TAM-ber), as used in all MSS documentation, refers to the set of data which determines all performance characteristics of a musical instrument. The data describing a timbre may occupy as little as 14 bytes for a Yamaha OPL2-type FM voice, or several hundred kilobytes for an ultra-high-quality wavetable instrument definition. Additionally, some synthesizers may require that multiple levels of "patches," "waveforms," "multisamples," "presets," or other constructs be considered as aspects of the timbre definition as it relates to MSS-based MIDI performance. </p><p>Under the MSS 2.X standard, the API module allowed extensive application-level control over the management of instrument data. Instrument data for all supported synthesizers, regardless of voice format, was maintained in a <i>GTL file</i>, or <i>G</i>lobal <i>T</i>imbre <i>L</i>ibrary file. The GTL file concept was ideal for working with highly-programmable synthesizers with relatively small timbre data sizes, such as the OPL2, OPL3, and Roland MT-32 platforms. However, MSS 2.X's technique of allowing the application program to manage timbres directly proved inflexible with the arrival of General MIDI and its accompanying entourage of wavetable synthesizers. Often, instrument definitions for the new synthesizers could no longer be shoehorned into monolithic, easily managed blocks of application memory. Discouraged by a multitude of incompatible, proprietary "standards," third-party tools for the creation and archival of wavetable samples were rare to nonexistent. OEM driver developers were thwarted in their efforts to resolve these issues by MSS 2.X's strict prohibition against DOS or other system calls within drivers. </p><p>The GTL standard remains in place under the current MSS, but several fundamental changes have occurred in the area of timbre management. The most important of these changes is that the driver, not the application, is now responsible for accessing GTL files, proprietary instrument library files, or both. Virtually all MSS 2.X applications contained a "timbre request" loop similar to the following: </p><p></p><code><font size=3 color=#006000><pre><br>while ((treq = AIL_timbre_request(driver,sequence)) != 0xffff)<br>{<br>   bank = treq / 256; patch = treq % 256;<br>   data = load_global_timbre(GTL,bank,patch);<br>   if (timb != NULL)<br>   {<br>      AIL_install_timbre(driver,bank,patch,data);<br>      free(timb);<br>   }<br>}<br></pre></font></code><p></p><p> This loop would typically be executed after registering an XMIDI sequence with MSS, and before starting playback. The old <i>AIL_timbre_request</i> function would examine the XMIDI file image to check for timbres used by the sequence which did not correspond to instruments currently present in the timbre cache. If any timbres were "requested" in this manner, the application would open the GTL file and fetch the timbre's data block, supplying it to the driver with a call to <a href="AIL_install_timbre.html">AIL_install_timbre</a>. This process would continue until all timbres required to play the XMIDI sequence had been uploaded to the synthesizer or cached in system RAM, depending on the synthesizer platform. </p><p>Current MSS drivers which support MSS 2.X-compatible Global Timbre Library files must implement the basic algorithm above in Function 503H (Install Timbre Set). Most OEM-developed drivers, however, will not need to deal with GTL compatibility. Instead, the Function 503H (Install Timbre Set) handlers in these drivers will either return immediately with AX = -1 if the synthesizer does not support uploadable instruments or if the complete instrument set is present in ROM, or, in cases where uploadable instruments are supported and/or required, handle the necessary uploading and memory management tasks in a manner transparent to MSS. </p><p>The list of timbres required to play a given XMIDI sequence appears in the sequence's XMIDI file image in the form of an IFF (Interchange File Format) chunk of type TIMB: </p><p></p><code><font size=3 color=#006000><pre><br>[<br>   TIMB<len><br>   U16 # of timbre list entries, 0-16384<br>   {<br>      U8 patch number 0-127<br>      U8 timbre bank 0-127<br>   }<br>   ...<br>]<br></pre></font></code><p></p><p> Prior to calling this function, the entire TIMB chunk is copied to the DST's 512-byte <b>MIDI_data</b>[] array. This is the same area of memory used to communicate with Function 502H (Transmit MIDI Data). TIMB chunks longer than 512 bytes will be split into smaller sub-chunks and passed in subsequent calls to the function. The <i>patch number</i> for each timbre entry corresponds to the normal MIDI Program Change controller value used to associate a patch with a given MIDI channel. Through the addition of the XMIDI Patch Bank Select controller (114) to the MSS MIDI implementations, the basic MIDI Program Change architecture has been extended to accommodate up to 16,384 unique instruments by combining a <i>timbre bank</i> (also called a <i>patch bank</i>) value with each patch number. Patch number/timbre bank pairs are often expressed as two-byte integers or <i>bank/patch specifiers</i>, in which the low byte corresponds to the patch number and the high byte corresponds to its timbre bank. </p><p>By default, the timbre bank value for channels which do not use the XMIDI Patch Bank Select controller is 0. Under MSS 2.X, patch bank 0 corresponded to the default MT-32 instrument set, or its emulated equivalent on the Ad Lib and other synthesizers. <i>Under the current MSS, however, patch bank 0 now corresponds to the General MIDI patch set.</i> Other bank numbers, chosen by the composer, must be used for custom instruments or MT-32 emulation. This change has been made in response to the overwhelming success of General MIDI in the interactive music field, and the accompanying decline in importance of the older MT-32 MIDI standard among MSS users. </p><p>This function may safely perform DOS or other system-level accesses where necessary. It will never be called from an unprotected asynchronous interrupt handler, or under conditions which preclude the availability of DOS and BIOS services. </p>
<p>
<br>
<b>Group:</b>
<a href="DOS XMIDI Sound Drivbjn2un.html">DOS XMIDI Sound Driver Interface</a><br>
<b>Related Functions:</b>
<a href="AIL_install_timbre.html">AIL_install_timbre</a></p>
<p align=center>
<a href="mailto:Miles@radgametools.com">For technical support, e-mail Miles@radgametools.com</a>
<br>
<a href="http://www.radgametools.com/miles.htm?from=help6.1c">&#169; Copyright 1991-2001 RAD Game Tools, Inc. All Rights Reserved.</a>
</p>
<br>
</body>
</html>
